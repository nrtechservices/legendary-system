<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>N'RTECH Manager Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #f59e0b; /* Warm Gold */
            --primary-dim: rgba(245, 158, 11, 0.15);
            --bg: #0f172a; /* Deep Black/Blue */
            --surface: #1e293b; /* Card Grey */
            --surface-light: #334155;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-top: var(--header-height);
            padding-bottom: calc(var(--nav-height) + 20px);
            overflow-x: hidden;
            user-select: none;
        }

        /* --- UI ELEMENTS --- */
        .app-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--surface); display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
            border-bottom: 1px solid #334155;
        }

        .brand { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.1rem; }
        .brand span { color: var(--primary); }
        
        .save-indicator {
            font-size: 0.7rem; color: var(--success); font-weight: 600; opacity: 0; transition: opacity 0.5s;
            position: absolute; right: 140px; top: 22px;
        }

        .month-selector {
            background: var(--bg); color: var(--primary); border: 1px solid var(--surface-light);
            padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; outline: none; font-weight: 600;
        }

        .view-section { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .balance-card {
            text-align: center; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1);
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            border-bottom: 1px solid var(--surface-light); padding-bottom: 10px;
        }
        .section-title { font-weight: 700; color: var(--primary); font-size: 1rem; display:flex; align-items:center; gap:8px;} 
        
        .list-item {
            background: var(--bg); padding: 10px; border-radius: 10px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }

        input { background: transparent; border: none; color: var(--text-main); font-size: 0.95rem; outline: none; width: 100%; }
        input.amount { text-align: right; font-weight: 600; width: 80px; }
        .wdr-select { background: var(--surface-light); color: var(--text-main); border: none; border-radius: 5px; padding: 5px; font-size: 0.75rem; width: 60px; }

        .btn-icon { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-add { width: 100%; padding: 12px; border-radius: 12px; border: 1px dashed var(--primary); background: transparent; color: var(--primary); font-weight: 600; margin-top: 5px; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-stat { background: var(--surface); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; }
        .mini-stat label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; }
        .mini-stat div { font-size: 1.1rem; font-weight: 700; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface); display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #334155; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.75rem; background: none; border: none; cursor: pointer; width: 100%; padding: 10px 0; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }

        /* FAB & MENU */
        .fab {
            position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
            width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
            color: #000; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            font-size: 24px; display: flex; align-items: center; justify-content: center; z-index: 900;
        }
        .fab-options {
            position: fixed; bottom: calc(var(--nav-height) + 85px); right: 20px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
            z-index: 899; pointer-events: none; opacity: 0; transition: 0.2s;
        }
        .fab-options.open { pointer-events: auto; opacity: 1; }
        .fab-btn {
            background: var(--surface); color: white; padding: 10px 15px;
            border-radius: 20px; text-decoration: none; border: 1px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 0.9rem; display:flex; align-items:center; gap:8px;
        }

        /* --- GENERATOR STYLES (HIDDEN) --- */
        #render-container { position: fixed; left: -9999px; top: 0; z-index: -1; }

        /* A4 REPORT STYLE */
        .a4-page {
            width: 794px; /* A4 96DPI */
            min-height: 1123px;
            background: white; color: #1e293b;
            padding: 40px; font-family: "Segoe UI", sans-serif;
            position: relative;
        }
        .rep-header { text-align: center; border-bottom: 3px solid #f59e0b; padding-bottom: 20px; margin-bottom: 30px; }
        .rep-title { font-size: 28px; font-weight: 800; color: #0f172a; margin: 0; }
        .rep-meta { color: #64748b; font-size: 14px; margin-top: 5px; }
        
        .rep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .rep-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; }
        .rep-box h3 { margin: 0 0 10px 0; font-size: 14px; color: #64748b; text-transform: uppercase; }
        .rep-box .val { font-size: 24px; font-weight: bold; color: #0f172a; }

        .rep-section h2 { font-size: 18px; color: #f59e0b; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-top: 25px; }
        
        .rep-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        .rep-table th { text-align: left; background: #f1f5f9; padding: 8px; color: #475569; font-weight: 600; }
        .rep-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
        .rep-table .amount { text-align: right; font-family: monospace; font-weight: 600; }
        .rep-total-row td { border-top: 2px solid #cbd5e1; font-weight: bold; background: #fffbeb; }

        /* RECEIPT STYLE */
        .receipt {
            width: 350px; background: #fff; padding: 20px; color: #000;
            font-family: 'Courier New', monospace;
            border-top: 10px solid #f59e0b;
        }
        .rec-header { text-align: center; margin-bottom: 20px; }
        .rec-logo { font-size: 24px; font-weight: bold; letter-spacing: 2px; margin-bottom: 5px; }
        .rec-divider { border-top: 1px dashed #000; margin: 10px 0; }
        .rec-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
        .rec-total { font-weight: bold; font-size: 16px; margin-top: 10px; }
        .rec-footer { text-align: center; font-size: 10px; margin-top: 20px; color: #555; }

        /* Utilities */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-gold { color: var(--primary); }
    </style>
</head>
<body>

    <nav class="app-bar">
        <div class="brand">N'<span>R</span>TECH</div>
        <div id="save-msg" class="save-indicator">âœ… Saved</div>
        <select class="month-selector" id="monthSelect" onchange="loadMonth()">
            <option value="Jan_2026">Jan 2026</option>
            <option value="Feb_2026">Feb 2026</option>
            <option value="Mar_2026">Mar 2026</option>
            <option value="Apr_2026">Apr 2026</option>
            <option value="May_2026">May 2026</option>
            <option value="Jun_2026">Jun 2026</option>
        </select>
    </nav>

    <div id="tab-dash" class="view-section active">
        <div class="card balance-card">
            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px;">NET PROFIT THIS MONTH</div>
            <div style="font-size:2.5rem; font-weight:800; color:var(--primary);" id="dash-profit">â‚±0.00</div>
        </div>

        <div class="stat-grid">
            <div class="mini-stat">
                <label>Income</label>
                <div class="text-green" id="dash-income">â‚±0.00</div>
            </div>
            <div class="mini-stat">
                <label>Expenses</label>
                <div class="text-red" id="dash-expense">â‚±0.00</div>
            </div>
            <div class="mini-stat">
                <label>Liabilities</label>
                <div class="text-red" id="dash-liab">â‚±0.00</div>
            </div>
            <div class="mini-stat" style="border:1px solid var(--primary);">
                <label>Total Savings</label>
                <div class="text-gold" id="dash-savings">â‚±0.00</div>
            </div>
        </div>

        <div class="card" style="margin-top:15px;">
            <div class="section-header"><span class="section-title">Monthly Breakdown</span></div>
            <div style="position: relative; height: 200px; width: 100%;"><canvas id="barChart"></canvas></div>
        </div>
    </div>

    <div id="tab-trans" class="view-section">
        <div class="card">
            <div class="section-header">
                <span class="section-title text-green"><i class="fas fa-arrow-down"></i> Income</span>
                <span id="total-income" class="text-green font-bold">â‚±0.00</span>
            </div>
            <div id="list-income"></div>
            <button class="btn-add" onclick="addItem('income')">+ Add Income</button>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-arrow-up"></i> Expenses</span>
                <span id="total-expenses" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-expenses"></div>
            <button class="btn-add" onclick="addItem('expenses')">+ Add Expense</button>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-exclamation-circle"></i> Liabilities</span>
                <span id="total-liabilities" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-liabilities"></div>
            <button class="btn-add" onclick="addItem('liabilities')">+ Add Liability</button>
        </div>
    </div>

    <div id="tab-savings" class="view-section">
        <div class="card" style="border: 1px solid var(--primary);">
            <div class="section-header">
                <span class="section-title"><i class="fas fa-piggy-bank"></i> Allocation</span>
            </div>
            <div class="list-item">
                <span style="flex:1">Personal Use Adjustment</span>
                <input type="number" id="adj-personal" oninput="calculate()" placeholder="0" class="amount" style="color:var(--danger); width:100px;">
            </div>
            <hr style="border:0; border-top:1px dashed #334155; margin:15px 0;">
            <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                <div class="mini-stat">
                    <label>Business (40%)</label>
                    <div class="text-gold" id="save-biz">â‚±0</div>
                </div>
                <div class="mini-stat">
                    <label>Personal (40%)</label>
                    <div class="text-gold" id="save-personal">â‚±0</div>
                </div>
                <div class="mini-stat">
                    <label>Emergency (20%)</label>
                    <div class="text-gold" id="save-emergency">â‚±0</div>
                </div>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--danger);">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-money-bill-wave"></i> Withdrawals</span>
                <span id="total-withdrawn" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-withdrawals"></div>
            <button class="btn-add" style="border-color:var(--danger); color:var(--danger);" onclick="addItem('withdrawals')">+ Add Withdrawal</button>
        </div>

        <div class="card balance-card">
            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px;">NET CASH ON HAND</div>
            <div style="font-size:2rem; font-weight:800; color:white;" id="net-cash">â‚±0.00</div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('dash', this)">
            <i class="fas fa-home"></i><span>Home</span>
        </button>
        <button class="nav-item" onclick="switchTab('trans', this)">
            <i class="fas fa-list"></i><span>Items</span>
        </button>
        <button class="nav-item" onclick="switchTab('savings', this)">
            <i class="fas fa-wallet"></i><span>Save</span>
        </button>
    </div>

    <div class="fab-options" id="fabMenu">
        <button class="fab-btn" onclick="downloadReceipt()">ðŸ§¾ Receipt</button>
        <button class="fab-btn" onclick="downloadReport()">ðŸ“„ Monthly Report</button>
        <button class="fab-btn" onclick="addItem('income'); switchTab('trans', document.querySelectorAll('.nav-item')[1])">ðŸ’° Quick Income</button>
    </div>
    <button class="fab" onclick="toggleFab()"><i class="fas fa-plus"></i></button>

    <div id="render-container">
        
        <div id="a4-report" class="a4-page">
            <div class="rep-header">
                <h1 class="rep-title">N'RTECH MANAGER</h1>
                <div class="rep-meta">Monthly Financial Statement</div>
                <div class="rep-meta" style="font-weight:bold; color:#f59e0b; font-size:16px; margin-top:5px;" id="rep-month-display">JANUARY 2026</div>
            </div>

            <div class="rep-grid">
                <div class="rep-box" style="background:#ecfdf5; border-color:#a7f3d0;">
                    <h3>Total Income</h3>
                    <div class="val" style="color:#059669;" id="rep-income">â‚±0.00</div>
                </div>
                <div class="rep-box" style="background:#fef2f2; border-color:#fecaca;">
                    <h3>Total Expenses</h3>
                    <div class="val" style="color:#dc2626;" id="rep-expense">â‚±0.00</div>
                </div>
                <div class="rep-box" style="background:#fff7ed; border-color:#fed7aa;">
                    <h3>Net Profit</h3>
                    <div class="val" style="color:#d97706;" id="rep-profit">â‚±0.00</div>
                </div>
                <div class="rep-box" style="background:#eff6ff; border-color:#bfdbfe;">
                    <h3>Cash on Hand</h3>
                    <div class="val" style="color:#2563eb;" id="rep-cash">â‚±0.00</div>
                </div>
            </div>

            <div class="rep-section">
                <h2>Transaction Details</h2>
                <table class="rep-table">
                    <thead><tr><th>Description</th><th>Type</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody id="rep-rows"></tbody>
                </table>
            </div>

            <div class="rep-section">
                <h2>Savings Allocation</h2>
                <table class="rep-table">
                    <tr><td>Business Allocation (40%)</td><td class="amount" id="rep-sav-biz">â‚±0.00</td></tr>
                    <tr><td>Personal Allocation (40%)</td><td class="amount" id="rep-sav-pers">â‚±0.00</td></tr>
                    <tr><td>Emergency Fund (20%)</td><td class="amount" id="rep-sav-emer">â‚±0.00</td></tr>
                </table>
            </div>
            
            <div style="margin-top:50px; text-align:center; font-size:12px; color:#94a3b8;">
                Generated automatically by N'RTECH App on <span id="rep-gen-date"></span>
            </div>
        </div>

        <div id="receipt-area" class="receipt">
            <div class="rec-header">
                <div class="rec-logo">N'RTECH</div>
                <div>OFFICIAL RECEIPT</div>
                <div style="font-size:10px;" id="rec-date"></div>
            </div>
            <div class="rec-divider"></div>
            <div id="rec-items"></div>
            <div class="rec-divider"></div>
            <div class="rec-row rec-total">
                <span>TOTAL PROFIT</span>
                <span id="rec-total-val"></span>
            </div>
            <div class="rec-footer">Thank you for your business!</div>
        </div>
    </div>

<script>
    // --- APP LOGIC ---
    let currentMonth = "Jan_2026";
    let data = {};
    let barChartInst = null;
    let saveTimeout;

    // --- NAVIGATION ---
    function switchTab(tabId, btnElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        closeFab();
    }

    function toggleFab() {
        const fab = document.getElementById('fabMenu');
        fab.classList.toggle('open');
        document.querySelector('.fab i').classList.toggle('fa-plus');
        document.querySelector('.fab i').classList.toggle('fa-times');
    }

    function closeFab() {
        document.getElementById('fabMenu').classList.remove('open');
        document.querySelector('.fab i').classList.add('fa-plus');
        document.querySelector('.fab i').classList.remove('fa-times');
    }

    // --- DATA HANDLING ---
    function loadMonth() {
        currentMonth = document.getElementById('monthSelect').value;
        const saved = localStorage.getItem('NRAPP_' + currentMonth);
        
        if (saved) {
            data = JSON.parse(saved);
            if (!data.withdrawals) data.withdrawals = [];
            // Migration check
            data.withdrawals.forEach(w => { if(!w.cat) w.cat = 'personal'; });
        } else {
            data = {
                income: [{desc: "Service/Sales", val: 0}],
                expenses: [],
                liabilities: [],
                withdrawals: [],
                personalFare: 0
            };
        }
        document.getElementById('adj-personal').value = data.personalFare == 0 ? '' : data.personalFare;
        renderAll();
        calculate(false); // don't save immediately on load
    }

    function renderAll() {
        renderList('income', data.income);
        renderList('expenses', data.expenses);
        renderList('liabilities', data.liabilities);
        renderWithdrawals();
    }

    function renderList(type, list) {
        const container = document.getElementById(`list-${type}`);
        container.innerHTML = '';
        list.forEach((item, index) => {
            container.innerHTML += `
                <div class="list-item">
                    <input type="text" value="${item.desc}" oninput="update('${type}', ${index}, 'desc', this.value)" placeholder="Description">
                    <input type="number" class="amount" value="${item.val == 0 ? '' : item.val}" oninput="update('${type}', ${index}, 'val', this.value)" placeholder="0.00">
                    <button class="btn-icon" onclick="del('${type}', ${index})"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });
    }

    function renderWithdrawals() {
        const container = document.getElementById('list-withdrawals');
        container.innerHTML = '';
        data.withdrawals.forEach((item, index) => {
            container.innerHTML += `
                <div class="list-item">
                    <select class="wdr-select" onchange="update('withdrawals', ${index}, 'cat', this.value)">
                        <option value="business" ${item.cat === 'business' ? 'selected' : ''}>Biz</option>
                        <option value="personal" ${item.cat === 'personal' ? 'selected' : ''}>Pers</option>
                        <option value="emergency" ${item.cat === 'emergency' ? 'selected' : ''}>Emer</option>
                    </select>
                    <input type="text" value="${item.desc}" oninput="update('withdrawals', ${index}, 'desc', this.value)" placeholder="Reason">
                    <input type="number" class="amount" value="${item.val == 0 ? '' : item.val}" oninput="update('withdrawals', ${index}, 'val', this.value)" placeholder="0.00" style="color:var(--danger)">
                    <button class="btn-icon" onclick="del('withdrawals', ${index})"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });
    }

    function addItem(type) {
        if(type === 'withdrawals') data.withdrawals.push({desc: '', val: 0, cat: 'personal'});
        else data[type].push({desc: '', val: 0});
        renderAll();
        calculate();
        closeFab();
    }

    function del(type, index) {
        data[type].splice(index, 1);
        renderAll();
        calculate();
    }

    function update(type, index, field, val) {
        data[type][index][field] = (field === 'desc' || field === 'cat') ? val : parseFloat(val) || 0;
        calculate();
    }

    function calculate(shouldSave = true) {
        const sum = (arr) => arr.reduce((a, b) => a + (parseFloat(b.val)||0), 0);

        const inc = sum(data.income);
        const exp = sum(data.expenses);
        const liab = sum(data.liabilities);
        
        data.personalFare = parseFloat(document.getElementById('adj-personal').value) || 0;
        
        const netProfit = inc - exp - liab;
        const savingsBase = Math.max(0, netProfit - data.personalFare);

        // Withdrawals
        let wdrBiz = 0, wdrPers = 0, wdrEmer = 0;
        (data.withdrawals || []).forEach(w => {
            const val = parseFloat(w.val) || 0;
            if (w.cat === 'business') wdrBiz += val;
            if (w.cat === 'personal') wdrPers += val;
            if (w.cat === 'emergency') wdrEmer += val;
        });
        const totalWdr = wdrBiz + wdrPers + wdrEmer;

        // Allocations
        const baseBiz = savingsBase * 0.4;
        const basePers = savingsBase * 0.4;
        const baseEmer = savingsBase * 0.2;

        const netCash = savingsBase - totalWdr;

        // Update UI
        document.getElementById('dash-profit').innerText = fmt(netProfit);
        document.getElementById('dash-income').innerText = fmt(inc);
        document.getElementById('dash-expense').innerText = fmt(exp);
        document.getElementById('dash-liab').innerText = fmt(liab);
        document.getElementById('dash-savings').innerText = fmt(savingsBase);

        document.getElementById('total-income').innerText = fmt(inc);
        document.getElementById('total-expenses').innerText = fmt(exp);
        document.getElementById('total-liabilities').innerText = fmt(liab);
        document.getElementById('total-withdrawn').innerText = fmt(totalWdr);

        // Show Remaining Allocations
        document.getElementById('save-biz').innerText = fmt(baseBiz - wdrBiz);
        document.getElementById('save-personal').innerText = fmt(basePers - wdrPers);
        document.getElementById('save-emergency').innerText = fmt(baseEmer - wdrEmer);
        
        document.getElementById('net-cash').innerText = fmt(netCash);

        renderCharts(inc, exp, liab, netProfit);
        
        if(shouldSave) triggerSave();
    }

    // --- AUTO SAVE LOGIC ---
    function triggerSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            localStorage.setItem('NRAPP_' + currentMonth, JSON.stringify(data));
            const ind = document.getElementById('save-msg');
            ind.style.opacity = '1';
            setTimeout(() => { ind.style.opacity = '0'; }, 2000);
        }, 500); // 0.5s debounce
    }

    function renderCharts(inc, exp, liab, profit) {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        if(barChartInst) barChartInst.destroy();
        barChartInst = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expense', 'Liab', 'Profit'],
                datasets: [{
                    label: 'Amount',
                    data: [inc, exp, liab, profit],
                    backgroundColor: ['#10b981', '#ef4444', '#f87171', '#f59e0b'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#f1f5f9' }, grid: { display: false } }
                }
            }
        });
    }

    // --- GENERATE IMAGES ---
    function fmt(n) { return 'â‚±' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    function downloadReceipt() {
        const items = document.getElementById('rec-items');
        items.innerHTML = '';
        document.getElementById('rec-date').innerText = new Date().toLocaleString();
        
        data.income.forEach(i => { if(i.val>0) items.innerHTML += `<div class="rec-row"><span>${i.desc}</span><span>${fmt(i.val)}</span></div>`; });
        data.expenses.forEach(i => { if(i.val>0) items.innerHTML += `<div class="rec-row"><span>${i.desc}</span><span>-${fmt(i.val)}</span></div>`; });
        
        document.getElementById('rec-total-val').innerText = document.getElementById('dash-profit').innerText;

        takeShot('receipt-area', `Receipt_${currentMonth}.jpg`);
    }

    function downloadReport() {
        // 1. Populate Report Data
        document.getElementById('rep-month-display').innerText = currentMonth.replace('_', ' ').toUpperCase();
        document.getElementById('rep-income').innerText = document.getElementById('dash-income').innerText;
        document.getElementById('rep-expense').innerText = document.getElementById('dash-expense').innerText;
        document.getElementById('rep-profit').innerText = document.getElementById('dash-profit').innerText;
        document.getElementById('rep-cash').innerText = document.getElementById('net-cash').innerText;
        
        document.getElementById('rep-sav-biz').innerText = document.getElementById('save-biz').innerText;
        document.getElementById('rep-sav-pers').innerText = document.getElementById('save-personal').innerText;
        document.getElementById('rep-sav-emer').innerText = document.getElementById('save-emergency').innerText;
        document.getElementById('rep-gen-date').innerText = new Date().toLocaleString();

        const tbody = document.getElementById('rep-rows');
        tbody.innerHTML = '';
        
        // Helper to add row
        const addRow = (desc, type, val, color) => {
            tbody.innerHTML += `<tr><td>${desc}</td><td style="color:${color}; font-size:12px;">${type}</td><td class="amount">${fmt(val)}</td></tr>`;
        };

        data.income.forEach(i => { if(i.val > 0) addRow(i.desc, "INCOME", i.val, "#059669"); });
        data.expenses.forEach(i => { if(i.val > 0) addRow(i.desc, "EXPENSE", -i.val, "#dc2626"); });
        data.liabilities.forEach(i => { if(i.val > 0) addRow(i.desc, "LIABILITY", -i.val, "#dc2626"); });
        data.withdrawals.forEach(i => { if(i.val > 0) addRow(i.desc, `WITHDRAWAL (${i.cat.toUpperCase()})`, -i.val, "#d97706"); });

        // 2. Capture
        takeShot('a4-report', `Report_${currentMonth}.jpg`);
    }

    function takeShot(elementId, filename) {
        closeFab();
        const element = document.getElementById(elementId);
        
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
    }

    // Init
    loadMonth();
</script>

</body>
</html>
