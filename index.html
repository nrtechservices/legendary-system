<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>N'RTECH Manager</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #f59e0b; /* Warm Gold */
            --primary-dim: rgba(245, 158, 11, 0.15);
            --bg: #0f172a; /* Deep Black/Blue */
            --surface: #1e293b; /* Card Grey */
            --surface-light: #334155;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-top: var(--header-height);
            padding-bottom: calc(var(--nav-height) + 20px);
            overflow-x: hidden;
            user-select: none;
        }

        /* --- APP BAR --- */
        .app-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height);
            background: var(--surface); display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
            border-bottom: 1px solid #334155;
        }

        .brand { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.1rem; letter-spacing: 0.5px; }
        .brand span { color: var(--primary); }
        .brand img { height: 32px; width: auto; }

        .month-selector {
            background: var(--bg); color: var(--primary); border: 1px solid var(--surface-light);
            padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; outline: none; font-weight: 600;
        }

        /* --- TABS --- */
        .view-section { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--surface); display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #334155; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: var(--text-sub);
            font-size: 0.75rem; background: none; border: none; cursor: pointer; width: 100%;
            padding: 10px 0; transition: 0.2s;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        
        /* --- CARDS --- */
        .card {
            background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .balance-card {
            text-align: center; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1);
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            border-bottom: 1px solid var(--surface-light); padding-bottom: 10px;
        }
        .section-title { font-weight: 700; color: var(--primary); font-size: 1rem; display:flex; align-items:center; gap:8px;} 
        
        /* --- LISTS & INPUTS --- */
        .list-item {
            background: var(--bg); padding: 10px; border-radius: 10px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 8px;
        }

        input { background: transparent; border: none; color: var(--text-main); font-size: 0.95rem; outline: none; width: 100%; }
        input.amount { text-align: right; font-weight: 600; width: 80px; }
        input::placeholder { color: #475569; }

        /* Specific Select style for Withdrawals */
        .wdr-select {
            background: var(--surface-light); color: var(--text-main); border: none;
            border-radius: 5px; padding: 5px; font-size: 0.75rem; width: 60px;
        }

        .btn-icon {
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: none; background: rgba(239, 68, 68, 0.15);
            color: var(--danger); cursor: pointer;
        }

        .btn-add {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px dashed var(--primary);
            background: transparent; color: var(--primary); font-weight: 600; margin-top: 5px;
        }
        .btn-add:active { background: var(--primary-dim); }

        /* --- DASHBOARD --- */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-stat {
            background: var(--surface); padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .mini-stat label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; }
        .mini-stat div { font-size: 1.1rem; font-weight: 700; }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
            width: 56px; height: 56px; border-radius: 50%; background: var(--primary);
            color: #000; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            font-size: 24px; display: flex; align-items: center; justify-content: center; z-index: 900;
        }
        .fab-options {
            position: fixed; bottom: calc(var(--nav-height) + 85px); right: 20px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
            z-index: 899; pointer-events: none; opacity: 0; transition: 0.2s;
        }
        .fab-options.open { pointer-events: auto; opacity: 1; }
        .fab-btn {
            background: var(--surface); color: white; padding: 10px 15px;
            border-radius: 20px; text-decoration: none; border: 1px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 0.9rem;
        }

        /* --- UTILS --- */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .text-gold { color: var(--primary); }
        .text-white { color: white; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .sub-info { font-size: 0.7rem; color: var(--text-sub); display: block; margin-top: 2px;}

        #receipt-render { position: fixed; top: -9999px; background: white; color: black; padding: 20px; width: 350px; }
        
            /* --- NEW ADDITIONS FOR REPORT & RECEIPT --- */
    
    /* A4 Report Container (Hidden off-screen) */
    #report-print-area {
        position: fixed; top: -10000px; left: 0;
        width: 794px; /* Standard A4 width at 96dpi */
        min-height: 1123px; /* Standard A4 height */
        background: white; color: #1e293b;
        padding: 40px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        box-sizing: border-box;
    }

    .rep-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px;
    }
    .rep-title h1 { margin: 0; color: #0f172a; font-size: 2rem; }
    .rep-title p { margin: 0; color: #64748b; }
    .rep-meta { text-align: right; }
    
    .rep-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .rep-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; }
    .rep-card h3 { margin: 0 0 10px 0; font-size: 0.9rem; text-transform: uppercase; color: #64748b; }
    .rep-val { font-size: 1.5rem; font-weight: 800; color: #0f172a; }

    .rep-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
    .rep-table th { text-align: left; background: #0f172a; color: white; padding: 8px; }
    .rep-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; color: #334155; }
    .rep-table tr:last-child td { border-bottom: 2px solid #0f172a; font-weight: bold; }
    
    .rep-footer {
        margin-top: 50px; padding-top: 20px; border-top: 1px solid #cbd5e1;
        text-align: center; color: #94a3b8; font-size: 0.8rem;
    }

    /* Improved Receipt Style */
    #receipt-render { 
        position: fixed; top: -9999px; left: 0; 
        width: 380px; background: #fff; color: #000; padding: 25px;
        font-family: 'Courier New', Courier, monospace; 
    }
    .rec-dashed { border-bottom: 2px dashed #000; margin: 10px 0; }
    .rec-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .rec-total { font-size: 1.2rem; font-weight: bold; margin-top: 10px; }

    </style>
</head>
<body>

    <nav class="app-bar">
        <div class="brand">
            <img src="logo.png" onerror="this.style.display='none'">
            <div>N'<span>R</span>TECH</div>
        </div>
        <select class="month-selector" id="monthSelect" onchange="loadMonth()">
            <option value="Jan_2026">Jan 2026</option>
            <option value="Feb_2026">Feb 2026</option>
            <option value="Mar_2026">Mar 2026</option>
            <option value="Apr_2026">Apr 2026</option>
            <option value="May_2026">May 2026</option>
            <option value="Jun_2026">Jun 2026</option>
            <option value="Jul_2026">Jul 2026</option>
            <option value="Aug_2026">Aug 2026</option>
            <option value="Sep_2026">Sep 2026</option>
            <option value="Oct_2026">Oct 2026</option>
            <option value="Nov_2026">Nov 2026</option>
            <option value="Dec_2026">Dec 2026</option>
        </select>
    </nav>

    <div id="tab-dash" class="view-section active">
        <div class="card balance-card">
            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px;">NET PROFIT THIS MONTH</div>
            <div style="font-size:2.5rem; font-weight:800; color:var(--primary);" id="dash-profit">â‚±0.00</div>
        </div>

        <div class="stat-grid">
            <div class="mini-stat">
                <label>Income</label>
                <div class="text-green" id="dash-income">â‚±0.00</div>
            </div>
            <div class="mini-stat">
                <label>Expenses</label>
                <div class="text-red" id="dash-expense">â‚±0.00</div>
            </div>
            <div class="mini-stat">
                <label>Liabilities</label>
                <div class="text-red" id="dash-liab">â‚±0.00</div>
            </div>
            <div class="mini-stat" style="border:1px solid var(--primary);">
                <label>Total Savings</label>
                <div class="text-gold" id="dash-savings">â‚±0.00</div>
            </div>
        </div>

        <div class="card" style="margin-top:15px;">
            <div class="section-header">
                <span class="section-title"><i class="fas fa-chart-bar"></i> Monthly Breakdown</span>
            </div>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title"><i class="fas fa-chart-line"></i> Yearly Trend (Profit)</span>
            </div>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title">Yearly Summary</span>
                <button onclick="calcYearly()" style="background:none; border:none; color:var(--primary); font-size:0.8rem;">REFRESH</button>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="color:var(--text-sub)">All Time Profit:</span>
                <span style="font-weight:bold; color:var(--primary);" id="year-profit">--</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="color:var(--text-sub)">Total Revenue:</span>
                <span style="font-weight:bold; color:white;" id="year-revenue">--</span>
            </div>
        </div>
    </div>

    <div id="tab-trans" class="view-section">
        <div class="card">
            <div class="section-header">
                <span class="section-title text-green"><i class="fas fa-arrow-down"></i> Income</span>
                <span id="total-income" class="text-green font-bold">â‚±0.00</span>
            </div>
            <div id="list-income"></div>
            <button class="btn-add" onclick="addItem('income')">+ Add Income</button>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-arrow-up"></i> Expenses</span>
                <span id="total-expenses" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-expenses"></div>
            <button class="btn-add" onclick="addItem('expenses')">+ Add Expense</button>
        </div>

        <div class="card">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-exclamation-circle"></i> Liabilities</span>
                <span id="total-liabilities" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-liabilities"></div>
            <button class="btn-add" onclick="addItem('liabilities')">+ Add Liability</button>
        </div>
    </div>

    <div id="tab-receivables" class="view-section">
        <div class="card">
            <div class="section-header">
                <span class="section-title"><i class="fas fa-hand-holding-usd"></i> Debtors</span>
                <span style="font-size:0.8rem;" id="total-collected">Col: â‚±0</span>
            </div>
            <div style="font-size:0.75rem; color:var(--text-sub); display:flex; margin-bottom:10px; padding:0 10px;">
                <span style="flex:2">Name</span>
                <span style="flex:1; text-align:right">Debt</span>
                <span style="flex:1; text-align:right">Paid</span>
                <span style="width:30px"></span>
            </div>
            <div id="list-receivables"></div>
            <button class="btn-add" onclick="addItem('receivables')">+ Add Debtor</button>
        </div>
    </div>

    <div id="tab-savings" class="view-section">
        <div class="card" style="border: 1px solid var(--primary);">
            <div class="section-header">
                <span class="section-title"><i class="fas fa-piggy-bank"></i> Allocation (Remaining)</span>
            </div>
            
            <div class="list-item" style="justify-content:space-between;">
                <span>Collections</span>
                <span class="text-green font-bold" id="disp-col">â‚±0.00</span>
            </div>
            <div class="list-item">
                <span style="flex:1">Less: Personal Use</span>
                <input type="number" id="adj-personal" oninput="calculate()" placeholder="0" class="amount" style="color:var(--danger); width:100px;">
            </div>

            <hr style="border:0; border-top:1px dashed #334155; margin:15px 0;">

            <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
                <div class="list-item" style="background:var(--surface-light); flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <span>Business (40%)</span>
                        <span class="text-gold font-bold" style="font-size:1.1rem;" id="save-biz">â‚±0</span>
                    </div>
                    <span class="sub-info" id="info-biz">Allocated: 0 | Wdr: 0</span>
                </div>

                <div class="list-item" style="background:var(--surface-light); flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <span>Personal (40%)</span>
                        <span class="text-gold font-bold" style="font-size:1.1rem;" id="save-personal">â‚±0</span>
                    </div>
                    <span class="sub-info" id="info-personal">Allocated: 0 | Wdr: 0</span>
                </div>

                <div class="list-item" style="background:var(--surface-light); flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <span>Emergency (20%)</span>
                        <span class="text-gold font-bold" style="font-size:1.1rem;" id="save-emergency">â‚±0</span>
                    </div>
                    <span class="sub-info" id="info-emergency">Allocated: 0 | Wdr: 0</span>
                </div>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--danger);">
            <div class="section-header">
                <span class="section-title text-red"><i class="fas fa-money-bill-wave"></i> Withdrawals</span>
                <span id="total-withdrawn" class="text-red font-bold">â‚±0.00</span>
            </div>
            <div id="list-withdrawals"></div>
            <button class="btn-add" style="border-color:var(--danger); color:var(--danger);" onclick="addItem('withdrawals')">+ Add Withdrawal</button>
        </div>

        <div class="card balance-card">
            <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:5px;">NET CASH ON HAND</div>
            <div style="font-size:2rem; font-weight:800; color:white;" id="net-cash">â‚±0.00</div>
            <div style="font-size:0.7rem; color:#aaa;">(Total Savings - Total Withdrawals)</div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('dash', this)">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="switchTab('trans', this)">
            <i class="fas fa-list"></i>
            <span>Items</span>
        </button>
        <button class="nav-item" onclick="switchTab('receivables', this)">
            <i class="fas fa-users"></i>
            <span>Debts</span>
        </button>
        <button class="nav-item" onclick="switchTab('savings', this)">
            <i class="fas fa-wallet"></i>
            <span>Save</span>
        </button>
    </div>

        <div class="fab-options" id="fabMenu">
        <button class="fab-btn" onclick="generateAndDownloadReport()">ðŸ“„ Full Report (A4)</button>
        <button class="fab-btn" onclick="downloadReceipt()">ðŸ§¾ Save Receipt</button>
        <button class="fab-btn" onclick="addItem('income'); switchTab('trans', document.querySelectorAll('.nav-item')[1])">ðŸ’° Quick Income</button>
    </div>

    
    <button class="fab" onclick="toggleFab()">
        <i class="fas fa-plus"></i>
    </button>

    <div id="receipt-render">
        <div style="text-align:center; border-bottom:2px dashed #000; padding-bottom:10px; margin-bottom:10px;">
            <h2 style="margin:0;">N'RTECH</h2>
            <p style="margin:0; font-size:0.8rem;">Official Receipt</p>
            <p id="rec-date" style="font-size:0.7rem; color:#555;"></p>
        </div>
        <div id="rec-items" style="font-family:monospace; font-size:0.85rem;"></div>
        <div style="border-top:2px dashed #000; margin-top:10px; padding-top:5px; display:flex; justify-content:space-between; font-weight:bold;">
            <span>NET PROFIT:</span>
            <span id="rec-total"></span>
        </div>
    </div>


    <div id="report-print-area">
        <div class="rep-header">
            <div class="rep-title">
                <h1>N'RTECH</h1>
                <p>Monthly Financial Report</p>
            </div>
            <div class="rep-meta">
                <div style="font-weight:bold; font-size:1.2rem;" id="rep-month-display">JAN 2026</div>
                <div style="font-size:0.8rem;">Generated: <span id="rep-gen-date"></span></div>
            </div>
        </div>

        <div class="rep-grid">
            <div class="rep-card">
                <h3>Net Profit</h3>
                <div class="rep-val" style="color:var(--primary)" id="rep-net-profit">â‚±0.00</div>
            </div>
            <div class="rep-card">
                <h3>Cash On Hand</h3>
                <div class="rep-val" id="rep-cash-hand">â‚±0.00</div>
            </div>
        </div>

        <div style="display:flex; gap:20px; align-items:flex-start;">
            <div style="flex:1">
                <h4 style="margin-bottom:10px; color:#10b981;">INCOME FLOW</h4>
                <table class="rep-table">
                    <thead><tr><th>Source</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody id="rep-table-inc"></tbody>
                </table>
            </div>
            <div style="flex:1">
                <h4 style="margin-bottom:10px; color:#ef4444;">EXPENSES & LIAB</h4>
                <table class="rep-table">
                    <thead><tr><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
                    <tbody id="rep-table-exp"></tbody>
                </table>
            </div>
        </div>

        <h4 style="margin-bottom:10px; color:#f59e0b; margin-top:20px;">SAVINGS & ALLOCATION</h4>
        <table class="rep-table">
            <thead>
                <tr><th>Fund Type</th><th style="text-align:right">Allocated</th><th style="text-align:right">Withdrawn</th><th style="text-align:right">Remaining</th></tr>
            </thead>
            <tbody id="rep-table-sav"></tbody>
        </table>

        <div class="rep-footer">
            <p>This document is computer generated by N'RTECH Manager App.</p>
        </div>
    </div>

    <div id="receipt-render">
        <div style="text-align:center;">
            <h2 style="margin:0; letter-spacing:2px;">N'RTECH</h2>
            <p style="margin:5px 0 0 0; font-size:0.8rem;">OFFICIAL RECEIPT</p>
        </div>
        <div class="rec-dashed"></div>
        <div class="rec-row">
            <span>Date:</span>
            <span id="rec-date-new"></span>
        </div>
        <div class="rec-row">
            <span>Month:</span>
            <span id="rec-month-name"></span>
        </div>
        <div class="rec-dashed"></div>
        
        <div style="font-weight:bold; margin-bottom:5px;">DETAILS</div>
        <div id="rec-items-new"></div>
        
        <div class="rec-dashed"></div>
        <div class="rec-row rec-total">
            <span>TOTAL PROFIT:</span>
            <span id="rec-total-new"></span>
        </div>
        <div style="text-align:center; margin-top:20px; font-size:0.7rem;">
            Thank you for your hard work!
        </div>
    </div>

<script>
    // --- APP LOGIC ---
    let currentMonth = "Jan_2026";
    let data = {};
    let barChartInst = null;
    let lineChartInst = null;

    function switchTab(tabId, btnElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        window.scrollTo(0,0);
        closeFab();
    }

    function toggleFab() {
        document.getElementById('fabMenu').classList.toggle('open');
        document.querySelector('.fab i').classList.toggle('fa-plus');
        document.querySelector('.fab i').classList.toggle('fa-times');
    }
    
    function closeFab() {
        document.getElementById('fabMenu').classList.remove('open');
        document.querySelector('.fab i').classList.add('fa-plus');
        document.querySelector('.fab i').classList.remove('fa-times');
    }

    function loadMonth() {
        currentMonth = document.getElementById('monthSelect').value;
        const saved = localStorage.getItem('NRAPP_' + currentMonth);
        
        if (saved) {
            data = JSON.parse(saved);
            if (!data.withdrawals) data.withdrawals = [];
            // Backward compatibility: ensure existing withdrawals have a category
            data.withdrawals.forEach(w => { if(!w.cat) w.cat = 'personal'; });
        } else {
            data = {
                income: [{desc: "Service/Sales", val: 0}],
                expenses: [],
                liabilities: [],
                receivables: [],
                withdrawals: [],
                personalFare: 0
            };
        }
        document.getElementById('adj-personal').value = data.personalFare == 0 ? '' : data.personalFare;
        renderAll();
        calculate();
    }

    function renderAll() {
        renderList('income', data.income);
        renderList('expenses', data.expenses);
        renderList('liabilities', data.liabilities);
        renderWithdrawals(); // Special render for withdrawals
        renderRec();
    }

    // Standard list render (Inc, Exp, Liab)
    function renderList(type, list) {
        const container = document.getElementById(`list-${type}`);
        container.innerHTML = '';
        list.forEach((item, index) => {
            container.innerHTML += `
                <div class="list-item">
                    <input type="text" value="${item.desc}" oninput="update('${type}', ${index}, 'desc', this.value)" placeholder="Description">
                    <input type="number" class="amount" value="${item.val == 0 ? '' : item.val}" oninput="update('${type}', ${index}, 'val', this.value)" placeholder="0.00">
                    <button class="btn-icon" onclick="del('${type}', ${index})"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });
    }

    // Specific render for Withdrawals (includes Dropdown)
    function renderWithdrawals() {
        const container = document.getElementById('list-withdrawals');
        container.innerHTML = '';
        data.withdrawals.forEach((item, index) => {
            container.innerHTML += `
                <div class="list-item">
                    <select class="wdr-select" onchange="update('withdrawals', ${index}, 'cat', this.value)">
                        <option value="business" ${item.cat === 'business' ? 'selected' : ''}>Biz</option>
                        <option value="personal" ${item.cat === 'personal' ? 'selected' : ''}>Pers</option>
                        <option value="emergency" ${item.cat === 'emergency' ? 'selected' : ''}>Emer</option>
                    </select>
                    <input type="text" value="${item.desc}" oninput="update('withdrawals', ${index}, 'desc', this.value)" placeholder="Reason">
                    <input type="number" class="amount" value="${item.val == 0 ? '' : item.val}" oninput="update('withdrawals', ${index}, 'val', this.value)" placeholder="0.00" style="color:var(--danger)">
                    <button class="btn-icon" onclick="del('withdrawals', ${index})"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });
    }

    function renderRec() {
        const container = document.getElementById('list-receivables');
        container.innerHTML = '';
        data.receivables.forEach((item, index) => {
            container.innerHTML += `
                <div class="list-item">
                    <input type="text" value="${item.desc}" oninput="updateRec(${index}, 'desc', this.value)" placeholder="Name" style="flex:2">
                    <input type="number" class="amount" value="${item.total == 0 ? '' : item.total}" oninput="updateRec(${index}, 'total', this.value)" placeholder="Debt" style="flex:1">
                    <input type="number" class="amount text-green" value="${item.paid == 0 ? '' : item.paid}" oninput="updateRec(${index}, 'paid', this.value)" placeholder="Paid" style="flex:1">
                    <button class="btn-icon" onclick="del('receivables', ${index})"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
        });
    }

    function addItem(type) {
        if(type === 'receivables') data.receivables.push({desc: '', total: 0, paid: 0});
        else if(type === 'withdrawals') data.withdrawals.push({desc: '', val: 0, cat: 'personal'}); // Default cat
        else data[type].push({desc: '', val: 0});
        renderAll();
        save();
        closeFab();
    }

    function del(type, index) {
        data[type].splice(index, 1);
        renderAll();
        calculate();
    }

    function update(type, index, field, val) {
        // If updating category, keep as string, else parse float
        data[type][index][field] = (field === 'desc' || field === 'cat') ? val : parseFloat(val) || 0;
        calculate();
    }

    function updateRec(index, field, val) {
        data.receivables[index][field] = field === 'desc' ? val : parseFloat(val) || 0;
        calculate();
    }

    function calculate() {
        const sum = (arr) => arr.reduce((a, b) => a + (parseFloat(b.val)||0), 0);
        const sumRec = (arr) => arr.reduce((a, b) => a + (parseFloat(b.paid)||0), 0);

        const inc = sum(data.income);
        const exp = sum(data.expenses);
        const liab = sum(data.liabilities);
        const col = sumRec(data.receivables);
        
        data.personalFare = parseFloat(document.getElementById('adj-personal').value) || 0;
        
        const netProfit = inc - exp - liab;
        const savingsBase = netProfit + col - data.personalFare;
        const allocatedSavings = Math.max(0, savingsBase);

        // Calculate Withdrawals per category
        let wdrBiz = 0, wdrPers = 0, wdrEmer = 0;
        (data.withdrawals || []).forEach(w => {
            const val = parseFloat(w.val) || 0;
            if (w.cat === 'business') wdrBiz += val;
            if (w.cat === 'personal') wdrPers += val;
            if (w.cat === 'emergency') wdrEmer += val;
        });
        const totalWdr = wdrBiz + wdrPers + wdrEmer;

        // Base Allocations
        const baseBiz = allocatedSavings * 0.4;
        const basePers = allocatedSavings * 0.4;
        const baseEmer = allocatedSavings * 0.2;

        // Net Cash on Hand
        const netCash = allocatedSavings - totalWdr;

        // Update UI Text
        document.getElementById('dash-profit').innerText = fmt(netProfit);
        document.getElementById('dash-income').innerText = fmt(inc);
        document.getElementById('dash-expense').innerText = fmt(exp);
        document.getElementById('dash-liab').innerText = fmt(liab);
        document.getElementById('dash-savings').innerText = fmt(allocatedSavings);

        document.getElementById('total-income').innerText = fmt(inc);
        document.getElementById('total-expenses').innerText = fmt(exp);
        document.getElementById('total-liabilities').innerText = fmt(liab);
        
        // Update Withdrawal Section
        document.getElementById('total-withdrawn').innerText = fmt(totalWdr);

        // Update Allocations (Show Remaining)
        document.getElementById('save-biz').innerText = fmt(baseBiz - wdrBiz);
        document.getElementById('save-personal').innerText = fmt(basePers - wdrPers);
        document.getElementById('save-emergency').innerText = fmt(baseEmer - wdrEmer);

        // Update Sub-info strings
        document.getElementById('info-biz').innerText = `Allocated: ${fmtS(baseBiz)} | Wdr: ${fmtS(wdrBiz)}`;
        document.getElementById('info-personal').innerText = `Allocated: ${fmtS(basePers)} | Wdr: ${fmtS(wdrPers)}`;
        document.getElementById('info-emergency').innerText = `Allocated: ${fmtS(baseEmer)} | Wdr: ${fmtS(wdrEmer)}`;
        
        document.getElementById('total-collected').innerText = "Col: " + fmt(col);
        document.getElementById('disp-col').innerText = fmt(col);
        document.getElementById('net-cash').innerText = fmt(netCash);

        save();
        renderCharts(inc, exp, liab, netProfit);
    }

    function renderCharts(inc, exp, liab, profit) {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        if(barChartInst) barChartInst.destroy();
        barChartInst = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expense', 'Liab', 'Profit'],
                datasets: [{
                    label: 'Amount',
                    data: [inc, exp, liab, profit],
                    backgroundColor: ['#10b981', '#ef4444', '#f87171', '#f59e0b'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#f1f5f9' }, grid: { display: false } }
                }
            }
        });

        const yearlyData = getYearlyTrend();
        const ctxLine = document.getElementById('lineChart').getContext('2d');
        if(lineChartInst) lineChartInst.destroy();
        lineChartInst = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: yearlyData.labels,
                datasets: [{
                    label: 'Net Profit',
                    data: yearlyData.profits,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                }
            }
        });
    }

    function getYearlyTrend() {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        let labels = [], profits = [];
        const keys = [];
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('NRAPP_')) keys.push(k);
        }
        keys.sort((a,b) => {
            const [p1, m1, y1] = a.split('_');
            const [p2, m2, y2] = b.split('_');
            if(y1 !== y2) return y1 - y2;
            return months.indexOf(m1) - months.indexOf(m2);
        });
        keys.forEach(k => {
            const d = JSON.parse(localStorage.getItem(k));
            const sum = (arr) => arr.reduce((acc, x) => acc + (x.val||0), 0);
            const inc = sum(d.income), exp = sum(d.expenses), liab = sum(d.liabilities);
            labels.push(k.replace('NRAPP_', '').replace('_', ' '));
            profits.push(inc - exp - liab);
        });
        return { labels, profits };
    }

    function calcYearly() {
        let allProf = 0, allRev = 0;
        for(let i=0; i<localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('NRAPP_')) {
                const d = JSON.parse(localStorage.getItem(key));
                const inc = d.income.reduce((a,b)=>a+(b.val||0),0);
                const exp = d.expenses.reduce((a,b)=>a+(b.val||0),0);
                const liab = d.liabilities.reduce((a,b)=>a+(b.val||0),0);
                allRev += inc;
                allProf += (inc - exp - liab);
            }
        }
        document.getElementById('year-profit').innerText = fmt(allProf);
        document.getElementById('year-revenue').innerText = fmt(allRev);
    }

    function downloadReceipt() {
        const area = document.getElementById('receipt-render');
        const items = document.getElementById('rec-items');
        items.innerHTML = '';
        document.getElementById('rec-date').innerText = new Date().toLocaleString();
        
        data.income.forEach(i => { if(i.val>0) items.innerHTML += `<div style="display:flex; justify-content:space-between;"><span>${i.desc}</span><span>${fmt(i.val)}</span></div>`; });
        data.expenses.forEach(i => { if(i.val>0) items.innerHTML += `<div style="display:flex; justify-content:space-between;"><span>${i.desc}</span><span>-${fmt(i.val)}</span></div>`; });
        
        document.getElementById('rec-total').innerText = document.getElementById('dash-profit').innerText;

        area.style.top = "0"; 
        html2canvas(area).then(canvas => {
            const link = document.createElement('a');
            link.download = `Receipt_${currentMonth}.png`;
            link.href = canvas.toDataURL();
            link.click();
            area.style.top = "-9999px"; 
            closeFab();
        });
    }

    function fmt(n) { return 'â‚±' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function fmtS(n) { return 'â‚±' + n.toLocaleString('en-US', {maximumFractionDigits:0}); } // Short format for sub-info
    function save() { localStorage.setItem('NRAPP_' + currentMonth, JSON.stringify(data)); }

    loadMonth();
    
        // --- NEW REPORT & RECEIPT LOGIC ---

    function generateAndDownloadReport() {
        // 1. Populate Header
        document.getElementById('rep-month-display').innerText = currentMonth.replace('_', ' ');
        document.getElementById('rep-gen-date').innerText = new Date().toLocaleString();

        // 2. Populate Big Stats
        document.getElementById('rep-net-profit').innerText = document.getElementById('dash-profit').innerText;
        document.getElementById('rep-cash-hand').innerText = document.getElementById('net-cash').innerText;

        // 3. Populate Income Table
        const incBody = document.getElementById('rep-table-inc');
        incBody.innerHTML = '';
        data.income.forEach(x => {
            if(x.val > 0) incBody.innerHTML += `<tr><td>${x.desc}</td><td style="text-align:right">${fmt(x.val)}</td></tr>`;
        });
        incBody.innerHTML += `<tr><td><strong>TOTAL</strong></td><td style="text-align:right"><strong>${document.getElementById('dash-income').innerText}</strong></td></tr>`;

        // 4. Populate Expense/Liab Table
        const expBody = document.getElementById('rep-table-exp');
        expBody.innerHTML = '';
        data.expenses.forEach(x => {
            if(x.val > 0) expBody.innerHTML += `<tr><td>${x.desc}</td><td style="text-align:right">-${fmt(x.val)}</td></tr>`;
        });
        data.liabilities.forEach(x => {
            if(x.val > 0) expBody.innerHTML += `<tr><td>${x.desc} (Liab)</td><td style="text-align:right">-${fmt(x.val)}</td></tr>`;
        });
        
        // 5. Populate Savings Logic
        // We recalculate temporarily to get raw numbers
        let totalWdrBiz = 0, totalWdrPers = 0, totalWdrEmer = 0;
        data.withdrawals.forEach(w => {
            if(w.cat === 'business') totalWdrBiz += (parseFloat(w.val)||0);
            if(w.cat === 'personal') totalWdrPers += (parseFloat(w.val)||0);
            if(w.cat === 'emergency') totalWdrEmer += (parseFloat(w.val)||0);
        });

        // Parse the text displayed on dashboard to get allocated amounts
        const getVal = (id) => parseFloat(document.getElementById(id).innerText.replace('Allocated: â‚±', '').replace(/,/g, ''));
        // Note: This relies on the sub-info text logic. For cleaner code, we can re-calculate, but this is faster for UI.
        const bizTxt = document.getElementById('info-biz').innerText;
        const perTxt = document.getElementById('info-personal').innerText;
        const emTxt = document.getElementById('info-emergency').innerText;

        const parseAlloc = (txt) => {
            const parts = txt.split('|');
            return parseFloat(parts[0].replace('Allocated: â‚±', '').replace(/,/g, '')) || 0;
        };

        const bizAlloc = parseAlloc(bizTxt);
        const perAlloc = parseAlloc(perTxt);
        const emAlloc = parseAlloc(emTxt);

        const savBody = document.getElementById('rep-table-sav');
        savBody.innerHTML = `
            <tr><td>Business Fund</td><td style="text-align:right">${fmt(bizAlloc)}</td><td style="text-align:right">${fmt(totalWdrBiz)}</td><td style="text-align:right">${fmt(bizAlloc - totalWdrBiz)}</td></tr>
            <tr><td>Personal Fund</td><td style="text-align:right">${fmt(perAlloc)}</td><td style="text-align:right">${fmt(totalWdrPers)}</td><td style="text-align:right">${fmt(perAlloc - totalWdrPers)}</td></tr>
            <tr><td>Emergency Fund</td><td style="text-align:right">${fmt(emAlloc)}</td><td style="text-align:right">${fmt(totalWdrEmer)}</td><td style="text-align:right">${fmt(emAlloc - totalWdrEmer)}</td></tr>
        `;

        // 6. Capture and Download
        const element = document.getElementById('report-print-area');
        
        // Temporarily move into view for rendering (top 0), but keep hidden z-index if needed
        // Since we used fixed top -10000, html2canvas needs it 'visible' in DOM logic
        
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Report_${currentMonth}.jpg`; // Saving as JPEG
            link.href = canvas.toDataURL('image/jpeg', 0.9); // 90% Quality JPEG
            link.click();
            closeFab();
        });
    }

    // Overwriting the old downloadReceipt function
    function downloadReceipt() {
        const area = document.getElementById('receipt-render');
        const items = document.getElementById('rec-items-new');
        
        document.getElementById('rec-date-new').innerText = new Date().toLocaleDateString();
        document.getElementById('rec-month-name').innerText = currentMonth.replace('_', ' ');
        items.innerHTML = '';

        // Add consolidated items
        data.income.forEach(i => { 
            if(i.val>0) items.innerHTML += `<div class="rec-row"><span>${i.desc}</span><span>${fmt(i.val)}</span></div>`; 
        });
        
        // Add divider if expenses exist
        if(data.expenses.length > 0 || data.liabilities.length > 0) {
            items.innerHTML += `<div class="rec-dashed" style="border-bottom-style:dotted; opacity:0.5;"></div>`;
        }

        data.expenses.forEach(i => { 
            if(i.val>0) items.innerHTML += `<div class="rec-row"><span>${i.desc}</span><span>-${fmt(i.val)}</span></div>`; 
        });
        
        document.getElementById('rec-total-new').innerText = document.getElementById('dash-profit').innerText;

        html2canvas(area, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Receipt_${currentMonth}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            closeFab();
        });
    }

</script>

</body>
</html>

